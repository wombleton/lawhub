(function(){Ext.define("LH.model.ActDetail",{extend:"Ext.data.Model",fields:["deleted","inserted","title"]}),Ext.define("LH.model.Detail",{extend:"Ext.data.Model",fields:["key","acts","tags","title"]}),Ext.define("LH.model.Government",{extend:"Ext.data.Model",fields:["_id","description",{name:"start",type:"date",convert:function(a){return new Date(a)}},{name:"end",type:"date",convert:function(a){return new Date(a)}},"inserted","deleted","theme"]}),Ext.define("LH.model.KeyWord",{extend:"Ext.data.Model",fields:["count","word"]}),Ext.define("LH.model.Revision",{extend:"Ext.data.Model",fields:["_id","title",{name:"updated",type:"date",convert:function(a){return new Date(a)}},"html",{name:"file_path",dataIndex:"file_path",convert:function(a){return"http://www.legislation.govt.nz/subscribe/"+a.match(/.*\/raw\/(.+\/).*/,"$1")[1]}}]}),Ext.define("LH.store.ActDetails",{extend:"Ext.data.ArrayStore",model:"LH.model.ActDetail"}),Ext.define("LH.store.Details",{extend:"Ext.data.Store",model:"LH.model.Detail",proxy:{buildUrl:function(a){return"/details/"+this.record.get("_id")+".json"},reader:{type:"json",root:"detail",successProperty:"success"},type:"ajax",url:"/details/key.json"}}),Ext.define("LH.store.Governments",{extend:"Ext.data.Store",model:"LH.model.Government",pageSize:100,proxy:{reader:{type:"json",root:"governments",successProperty:"success",totalProperty:"totalCount"},type:"ajax",url:"/governments.json"},sorters:[{property:"start",direction:"ASC"}]}),Ext.define("LH.store.KeyWords",{extend:"Ext.data.Store",model:"LH.model.KeyWord"}),Ext.define("LH.store.Revisions",{buffered:!0,extend:"Ext.data.Store",model:"LH.model.Revision",pageSize:5,proxy:{reader:{type:"json",root:"revisions",successProperty:"success",totalProperty:"totalCount"},type:"ajax",url:"/revisions/4e6e09d3ce6911bd1a000034.json"},remoteFilter:!0,remoteSort:!0}),Ext.define("LH.view.government.Detail",{alias:"widget.governmentdetail",border:!1,extend:"Ext.panel.Panel",flex:1,initComponent:function(){this.callParent(arguments);return this.on("activate",function(){var a;return(a=this.findParentByType("governmenttab"))!=null?a.updateHash(this):void 0},this)},layout:{align:"stretch",type:"border"},items:[{height:36,region:"north",xtype:"governmentsummary"},{flex:3,region:"west",xtype:"teara"},{flex:4,region:"center",xtype:"snake"},{flex:2,region:"east",xtype:"keywords"}],padding:"0 8"}),Ext.chart.theme.Legislation=Ext.extend(Ext.chart.theme.Base,{constructor:function(a){return Ext.chart.theme.Base.prototype.constructor.call(this,Ext.apply({colors:["#ff0000","#00ff00"]},a))}}),Ext.define("LH.view.government.Graph",{alias:"widget.governmentgraph",border:!1,extend:"Ext.chart.Chart",initComponent:function(){var a,b;a=Ext.data.StoreManager.get("Governments"),this.store=new Ext.data.Store({fields:["start","end","description","pm","total"]}),b=0,a.on("load",function(a,c){var d;Ext.getBody().unmask(),_.each(c,function(a){b+=a.get("inserted"),b-=a.get("deleted");return this.store.add({description:a.get("description"),inserted:a.get("inserted"),start:a.get("start"),end:a.get("end"),total:b})},this),d=_.last(c);return this.store.add({description:d.get("description"),inserted:d.get("inserted"),pm:"Wonky Donky",start:d.get("end"),end:d.get("end"),total:b})},this),a.load();return this.callParent(arguments)},series:[{axis:"left",highlight:!0,tips:{renderer:function(a){var b,c;c=Ext.Date.format(a.get("start"),"j M Y"),b=Ext.Date.format(a.get("end"),"j M Y");return this.setTitle(""+a.get("description")+" "+c+" - "+b+": Added "+a.get("inserted")+" lines")},width:100,trackMouse:!0},type:"area",xField:"start",yField:["total"]}],label:"Lines of legislation"}),Ext.define("LH.view.government.Introduction",{alias:"widget.introduction",border:!1,cls:"introduction",extend:"Ext.panel.Panel",html:'<h1>Kia ora!</h1>\n<p>This site shows the <em>changes in New Zealand legislation</em> over time. It\'s easy to use!</p>\n<p>To get started, click on one of the governments above from the <em>last 158 years</em>. Then you can click on the acts of parliament changed by that government to <em>see what happened</em> -- or you can do your own searches.</p>\n<p>The data powering this site is provided by <a href="http://www.legislation.govt.nz">legislation.govt.nz</a> and is free of copyright.</p>\n<p>Have fun!</p>\n<p>P.S. All errors are mine (and there <em>are</em> errors!) not that of the <a href="http://www.legislation.govt.nz">legislation.govt.nz</a>.</p >',layout:"fit",margins:8}),Ext.define("LH.view.government.KeyWords",{alias:"widget.keywords",autoScroll:!0,border:!0,extend:"Ext.panel.Panel",layout:"auto",title:"Keywords",fetch:function(){var a;this.removeAll(),a=Ext.StoreManager.get("Details"),this.setLoading(!0);return a.on("datachanged",function(a){var b,c,d;b=a.getRange(),c=((d=b[0])!=null?d.get("tags"):void 0)||[],_.each(c,function(a,b){if(b<50)return this.add(new Ext.button.Button({margin:5,text:a.word}))},this);return this.setLoading(!1)},this,{single:!0})},margins:8}),Ext.define("LH.view.government.Overview",{alias:"widget.overview",border:!1,extend:"Ext.panel.Panel",padding:"0 100",setActive:function(a){return this.get(1).layout.setActiveItem(a)},items:[{border:!1,title:"Total Legislation",xtype:"panel",layout:"fit",items:{xtype:"governmentgraph"},height:150},{height:36,xtype:"governmentstrip"},{flex:1,xtype:"governmenttab"}],layout:{align:"stretch",type:"vbox"}}),Ext.define("LH.view.government.Snake",{alias:"widget.snake",autoScroll:!0,border:!0,columns:[{header:"Act",dataIndex:"title",menuDisabled:!0,flex:1},{header:"Words Added",dataIndex:"inserted",menuDisabled:!0},{header:"Words Removed",dataIndex:"deleted",menuDisabled:!0}],extend:"Ext.grid.Panel",fetch:function(a){var b;this.setLoading(!0),b=Ext.StoreManager.get("Details"),b.on("datachanged",function(a){var b,c,d;this.store.removeAll(),c=a.getRange(),b=(d=c[0])!=null?d.get("acts"):void 0,b&&(this.view.refresh(),this.store.add(b));return this.setLoading(!1)},this),b.proxy.record=a;return b.load()},layout:"fit",title:"Acts Affected",margins:8,store:"ActDetails"}),Ext.define("LH.view.government.Strip",{alias:"widget.governmentstrip",border:!1,cls:"lh-govt-strip",extend:"Ext.panel.Panel",initComponent:function(){this.callParent(arguments),this.addEvents("governmentselect"),this.store=Ext.data.StoreManager.get("Governments");return this.store.on("load",function(a,b){return _.each(b,function(a,b){var c;c=new Ext.panel.Panel({cls:"lh-govt "+a.get("theme"),flex:1,html:""+(b+1),layout:"fit",qtip:"x",record:a}),c.on("render",function(b){Ext.create("Ext.tip.ToolTip",{target:b.body,html:""+a.get("description")});return b.body.on("click",function(){return this.react(b.record,b)},this)},this);return this.add(c)},this)},this)},react:function(a){_.each(this.items.getRange(),function(b){return a===b.record?b.addCls("active"):b.removeCls("active")});return this.fireEvent("governmentselect",a)},layout:{align:"stretch",type:"hbox"},padding:"0 8"}),Ext.define("LH.view.government.Summary",{alias:"widget.governmentsummary",border:!1,cls:"governmentsummary",extend:"Ext.panel.Panel",items:[{border:!1,flex:1},{border:!1,flex:1},{border:!1,flex:3}],layout:{align:"stretch",type:"hbox"},setText:function(a){var b,c;c=Ext.Date.format(a.get("start"),"j M Y"),b=Ext.Date.format(a.get("end"),"j M Y"),this.items.get(0).update(a.get("description")),this.items.get(1).update(""+c+" - "+b);return this.items.get(2).update("Added "+a.get("inserted")+" lines of legislation")},padding:"0 8"}),Ext.define("LH.view.government.Tab",{alias:"widget.governmenttab",border:!1,doTitleSearch:function(a){this.layout.setActiveItem(2);return this.query("revisionlist")[0].doSearch('title:"'+a.lastSelected.get("title")+'"')},doSearch:function(a){this.layout.setActiveItem(2);return this.query("revisionlist")[0].doSearch(a.text)},extend:"Ext.panel.Panel",initComponent:function(){this.callParent(arguments);return this.on("afterrender",function(){var a,b,c,d,e;e=_.compact((Ext.History.getToken()||"").split("/")),d=e[0],a=e[1],c=this.query("#"+d)[0],c&&this.layout.setActiveItem(c);if(d==="govts"&&a){b=Ext.StoreManager.get("Governments");return b.on("load",function(){var c,d,e,f,g,h,i;f=b.getAt(a-1);if(f){h=Ext.ComponentQuery.query("governmentstrip")[0],h.react(f),e=Ext.ComponentQuery.query("revisionlist")[0],e.setUrl(f),i=Ext.ComponentQuery.query("teara")[0],i!=null&&i.fetch(f),g=Ext.ComponentQuery.query("snake")[0],g!=null&&g.fetch(f),d=Ext.ComponentQuery.query("keywords")[0],d!=null&&d.fetch(f),c=Ext.ComponentQuery.query("governmentsummary");return _.each(c,function(a){return a.setText(f)})}},this,{single:!0})}})},updateHash:function(a){var b,c;b=Ext.History.getToken()||"",c="/"+a.id;if(b.indexOf(c)!==0)return Ext.History.add(c)},items:[{id:"intro",xtype:"introduction"},{id:"govts",xtype:"governmentdetail"},{id:"search",xtype:"revisioncontainer"}],flex:1,layout:"card"}),Ext.define("LH.view.government.TeAra",{alias:"widget.teara",autoScroll:!0,border:!1,cls:"teara",extend:"Ext.panel.Panel",fetch:function(a){var b,c,d;c=a.get("start"),b=new Date(a.get("end")),this.setTitle("Te Ara search: years "+Ext.Date.format(c,"Y")+" - "+Ext.Date.format(b,"Y")),d=[];while(c<b)d.push(Ext.Date.format(c,"Y")),c=Ext.Date.add(c,Ext.Date.YEAR,1);this.setLoading(!0);return Ext.Ajax.request({failure:function(){this.update("Whoops. Something went wrong.");return this.setLoading(!1)},url:"/teara/"+d.join(" "),scope:this,success:function(a){this.update(a.responseText);return this.setLoading(!1)}})},layout:"fit",margins:8,title:"Te Ara Content"}),Ext.define("LH.view.revision.Container",{alias:"widget.revisioncontainer",border:!1,extend:"Ext.panel.Panel",initComponent:function(){this.items=[{height:30,region:"north",xtype:"governmentsummary"},{flex:1,xtype:"revisionlist"}];return this.callParent(arguments)},layout:{align:"stretch",type:"vbox"}}),Ext.define("LH.view.revision.List",{afterRender:function(){return this.textfield=this.down("textfield[name=filter]")},alias:"widget.revisionlist",doSearch:function(a){this.textfield.setValue(a);return this.onFilterChange()},extend:"Ext.panel.Panel",initComponent:function(){this.tbar=["Filter",{hideLabel:!0,listeners:{change:{buffer:500,fn:this.onFilterChange,scope:this}},name:"filter",width:600,xtype:"textfield"},"->",{cls:"back",handler:function(){var a;a=Ext.ComponentQuery.query("governmenttab")[0];return a!=null?a.layout.setActiveItem(1):void 0},text:"Back",xtype:"button"}],this.store=Ext.StoreManager.get("Revisions"),this.dockedItems=[{xtype:"pagingtoolbar",store:this.store,dock:"bottom",displayInfo:!0}],this.panel=new Ext.panel.Panel({autoScroll:!0,layout:"auto",region:"center"}),this.items=this.panel,this.callParent(arguments);return this.store.on("datachanged",this.updateContent,this)},layout:{type:"fit"},updateContent:function(a){var b;b=a.getRange(),this.panel.removeAll();return _.each(b,function(a){return this.panel.add({html:a.get("html"),title:""+a.get("title")+" @ "+Ext.Date.format(a.get("updated"),"j M Y")+' <a href="'+a.get("file_path")+'">source</a>',xtype:"revisionview"})},this)},onFilterChange:function(){this.panel.setLoading(!0),this.store.on("datachanged",function(){return this.panel.setLoading(!1)},this),this.store.filters.clear();return this.store.filter("q",this.textfield.value)},setUrl:function(a){return this.store.proxy.url="/revisions/"+a.get("_id")+".json"},title:!1}),Ext.define("LH.view.act.Revision",{alias:"widget.revision",align:"stretch",border:!1,extend:"Ext.panel.Panel",initComponent:function(){this.title=Ext.Date.format(new Date(this.revision.updated),"j M Y"),this.revision.date_terminated?(this.title+=" (Repealed)",this.status="Repealed"):this.status="In force",this.callParent(arguments),this.add({autoScroll:!0,border:!1,html:this.revision.html,padding:10,region:"center",xtype:"panel"});return this.add({border:!1,fieldDefaults:{labelAlign:"right"},items:[{fieldLabel:"Path",listeners:{focus:function(){this.inputEl.dom.select();return!1}},value:this.revision.file_path,width:600,xtype:"textfield"},{fieldLabel:"Assented",value:this.revision.date_assent?Ext.Date.format(new Date(this.revision.date_assent),"j M Y"):"",xtype:"displayfield"},{fieldLabel:"Date As At",value:this.revision.date_as_at?Ext.Date.format(new Date(this.revision.date_as_at),"j M Y"):"",xtype:"displayfield"},{fieldLabel:"Date Updated",value:this.revision.udpated?Ext.Date.format(new Date(this.revision.updated),"j M Y"):"",xtype:"displayfield"},{fieldLabel:"Status",value:this.status,xtype:"displayfield"},{fieldLabel:"Year",value:this.revision.year,xtype:"displayfield"}],region:"north",xtype:"form"})},layout:"border"}),Ext.define("LH.view.act.Tab",{alias:"widget.acttab",border:!1,doSearch:function(a){return this.layout.setActiveItem(3)},extend:"Ext.panel.Panel",initComponent:function(){this.tbar=[{handler:function(){return this.layout.setActiveItem(0)},scope:this,text:"Back",xtype:"button"}," ","Lawhub"];return this.callParent(arguments)},items:[{xtype:"actlist"}],layout:"card"}),Ext.define("LH.view.revision.View",{alias:"widget.revisionview",border:!1,cls:"revisionview",extend:"Ext.panel.Panel",layout:{align:"stretch",type:"auto"}}),Ext.define("LH.controller.Governments",{extend:"Ext.app.Controller",init:function(){return this.control({governmentstrip:{governmentselect:function(a){var b,c,d,e,f,g,h,i,j;g=Ext.History.getToken(),d=Ext.StoreManager.get("Governments").indexOf(a),j="/govts/"+(d+1);if(j!==g){Ext.History.add(j),f=Ext.ComponentQuery.query("revisionlist")[0],f.setUrl(a),c=Ext.ComponentQuery.query("governmenttab")[0],c!=null&&c.layout.setActiveItem(1),i=Ext.ComponentQuery.query("teara")[0],i!=null&&i.fetch(a),h=Ext.ComponentQuery.query("snake")[0],h!=null&&h.fetch(a),e=Ext.ComponentQuery.query("keywords")[0],e!=null&&e.fetch(a),b=Ext.ComponentQuery.query("governmentsummary");return _.each(b,function(b){return b.setText(a)})}}},"keywords button":{click:function(a){var b;b=Ext.ComponentQuery.query("governmenttab")[0];return b!=null?b.doSearch(a):void 0}},snake:{select:function(a){var b;b=Ext.ComponentQuery.query("governmenttab")[0];return b!=null?b.doTitleSearch(a):void 0}}})},models:["ActDetail","Detail","KeyWord","Government"],stores:["ActDetails","Details","KeyWords","Governments"],views:["government.Overview","government.Detail","government.Strip","government.TeAra","government.Snake","government.KeyWords","government.Graph","government.Introduction","government.Tab","government.Summary"]}),Ext.define("LH.controller.Revisions",{extend:"Ext.app.Controller",models:["Revision"],stores:["Revisions"],views:["revision.List","revision.View","revision.Container"]}),Ext.application({controllers:["Governments","Revisions"],views:["overview"],launch:function(){Ext.History.init();return Ext.create("Ext.container.Viewport",{items:[{xtype:"overview"}],layout:{type:"fit"}})},name:"LH"})}).call(this)